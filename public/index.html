<!DOCTYPE html>
<html>
<head>
  <title>Guardian Listener</title>
  <meta charset="utf-8"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #map { height: 300px; margin-top: 15px; }
  </style>
</head>
<body>
  <h2>Guardian Listener</h2>

  <label>Server URL:</label>
  <input id="serverUrl" value="https://guardian-server.onrender.com" size="40">
  <button id="connectBtn">Connect</button>

  <h3>Live Audio</h3>
  <button id="playBtn">Play Audio</button>
  <audio id="audio" controls autoplay></audio>

  <h3>Live Location</h3>
  <div id="map"></div>

  <script>
    let socket;
    let audioCtx, sourceNode;
    let audioQueue = [];

    document.getElementById("connectBtn").onclick = () => {
      const url = document.getElementById("serverUrl").value;
      socket = io(url);

      socket.on("connect", () => {
        console.log("Connected as listener");
        socket.emit("listener_register", { role: "listener" });
      });

      socket.on("audio-chunk", (chunk) => {
        if (chunk) {
          audioQueue.push(new Uint8Array(chunk));
          playNext();
        }
      });

      socket.on("location-update", (data) => {
        if (data && data.lat && data.lng) {
          updateMap(data.lat, data.lng);
        }
      });
    };

    // Audio playback
    function playNext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioQueue.length > 0 && !sourceNode) {
        const chunk = audioQueue.shift();
        audioCtx.decodeAudioData(chunk.buffer.slice(0), (buffer) => {
          sourceNode = audioCtx.createBufferSource();
          sourceNode.buffer = buffer;
          sourceNode.connect(audioCtx.destination);
          sourceNode.onended = () => { sourceNode = null; playNext(); };
          sourceNode.start();
        });
      }
    }

    document.getElementById("playBtn").onclick = () => {
      if (audioCtx) audioCtx.resume();
    };

    // Map
    let map = L.map("map").setView([20, 78], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);
    let marker;

    function updateMap(lat, lng) {
      if (!marker) {
        marker = L.marker([lat, lng]).addTo(map);
      } else {
        marker.setLatLng([lat, lng]);
      }
      map.setView([lat, lng], 15);
    }
  </script>
</body>
</html>
